@page "/Dashboard"
<PageTitle>Dashboard Carian Maklumat Wakaf</PageTitle>

@layout MainLayout
@using CurrieTechnologies.Razor.SweetAlert2
@using DAL.Entiti
@using IdentityAuthentication
@using Microsoft.AspNetCore.Authorization
@using SAL
@using System.Security.Claims
@using eTakaf2025.Components.Layout

@attribute [Authorize]
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@inject IServices _service
@inject SweetAlertService Swal
@inject IConfiguration _conf
@inject NavigationManager NavMan
@inject IIdentityAuthenticationLib myIden

<div class="container-fluid">
    @if (adaRekod)
    {
       @*  <div class="dashboard-header py-4 mb-4">
            <div class="container">
                <h1 class="display-5 fw-bold"><i class="bi bi-geo-alt me-2"></i>Maklumat Tanah Wakaf Negeri Sembilan</h1>
                <p class="lead">Tanah Wakaf Am,Khas</p>
            </div>
        </div> *@
        <div class="container mb-5">
        <!-- Summary Card -->
            <div class="row mb-5">
                <div class="col-lg-4 col-md-6 col-12">
                    <div class="card stat-card total-card">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-0">JUMLAH TANAH WAKAF</h5>
                                <div class="stat-value mt-2">@TotalJumlahTW</div>
                                <div class="stat-label">Keseluruhan</div>
                            </div>
                            <div class="stat-icon">
                                <i class="bi bi-map"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 col-12">
                    <div class="card stat-card total-card">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-0">WAKAF AM</h5>
                                <div class="stat-value mt-2" @onclick="ShowTWAKosong" style="cursor: pointer;">@TanahKosongTWA</div>
                                <div class="stat-label">Tanah Kosong</div>
                            </div>
                            <div class="stat-icon">
                                <i class="bi bi-map"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 col-12">
                    <div class="card stat-card total-card">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-0">WAKAF KHAS</h5>
                                <div class="stat-value mt-2" @onclick="ShowTWKKosong" style="cursor: pointer;">@TanahKosongTWK</div>
                                <div class="stat-label">Tanah Kosong</div>
                            </div>
                            <div class="stat-icon">
                                <i class="bi bi-map"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

           @*  <div class="row mb-3">
                <div class="col-3">
                    <div class="card stat-card total-card">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-0">JUMLAH TANAH WAKAF</h5>
                                <div class="stat-value mt-2">@TotalJumlahTW</div>
                                <div class="stat-label">Keseluruhan</div>
                            </div>
                            <div class="stat-icon">
                                <i class="bi bi-map"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card stat-card total-card">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-0">WAKAF AM</h5>
                                <div class="stat-value mt-2" @onclick="ShowTWAKosong" style="cursor: pointer;">@TanahKosongTWA</div>
                                <div class="stat-label">Tanah Kosong</div>
                            </div>
                            <div class="stat-icon">
                                <i class="bi bi-map"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card stat-card total-card">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-0">WAKAF KHAS</h5>
                                <div class="stat-value mt-2">@TanahKosongTWK</div>
                                <div class="stat-label">Tanah Kosong</div>
                            </div>
                            <div class="stat-icon">
                                <i class="bi bi-map"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
 *@
            <!-- District Cards -->
            <div class="row g-4mt-3">
                <!-- Seremban Card -->
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>SEREMBAN</span>
                                <i class="bi bi-building"></i>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div class="stat-value">@SerembanJumlah</div>
                            <div class="stat-label">Bil. Tanah</div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="text-end mt-1"><small>@SerembanPercent.ToString("N2")% of @TotalJumlahTW</small></div>
                        </div>
                    </div>
                </div>

                <!-- Kuala Pilah Card -->
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Kuala Pilah</span>
                                <i class="bi bi-house"></i>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div class="stat-value">35</div>
                            <div class="stat-label">Bil. Tanah</div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 38%;" aria-valuenow="38" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="text-end mt-1"><small>@KualaPilahPercent.ToString("N2")% of @TotalJumlahTW</small></div>
                        </div>
                    </div>
                </div>

                <!-- Tampin Card -->
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Tampin</span>
                                <i class="bi bi-tree"></i>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div class="stat-value">28</div>
                            <div class="stat-label">Bil. Tanah</div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 30%;" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="text-end mt-1"><small>@TampinPercent.ToString("N2")% of @TotalJumlahTW</small></div>
                        </div>
                    </div>
                </div>

                <!-- Jelebu Card -->
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Jelebu</span>
                                <i class="bi bi-geo"></i>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div class="stat-value">19</div>
                            <div class="stat-label">Bil. Tanah</div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 21%;" aria-valuenow="21" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="text-end mt-1"><small>@JelebuPercent.ToString("N2")% of @TotalJumlahTW</small></div>
                        </div>
                    </div>
                </div>

                <!-- Port Dickson Card -->
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Port Dickson</span>
                                <i class="bi bi-water"></i>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div class="stat-value">16</div>
                            <div class="stat-label">Bil. Tanah</div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 17%;" aria-valuenow="17" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="text-end mt-1"><small>@PortDicksonPercent.ToString("N2")% of @TotalJumlahTW</small></div>
                        </div>
                    </div>
                </div>

                <!-- Rembau Card -->
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Rembau</span>
                                <i class="bi bi-pin-map"></i>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div class="stat-value">15</div>
                            <div class="stat-label">Bil. Tanah</div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-secondary" role="progressbar" style="width: 16%;" aria-valuenow="16" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="text-end mt-1"><small>@RembauPercent.ToString("N2")% of @TotalJumlahTW</small></div>
                        </div>
                    </div>
                </div>

                <!-- Jempol Card -->
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Jempol</span>
                                <i class="bi bi-signpost-2"></i>
                            </div>
                        </div>
                        <div class="card-body text-center">
                            <div class="stat-value">12</div>
                            <div class="stat-label">Bil. Tanah</div>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar" style="background-color: #7209b7; width: 13%;" role="progressbar" aria-valuenow="13" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="text-end mt-1"><small>@JempolPercent.ToString("N2")% of @TotalJumlahTW</small></div>
                        </div>
                    </div>
                </div>
            </div>

             <div class="row mt-5">
                <div class="col-6">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Jumlah Tanah Wakaf PerDaerah</span>
                                <i class="bi bi-bar-chart"></i>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="landChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card stat-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Jenis Tanah Wakaf</span>
                                <i class="bi bi-bar-chart"></i>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="landChart2"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
             </div>

        </div>
    }
</div>



@code {
    IEnumerable<DashboardInfo> _data = []; IEnumerable<DashboardInfo> _data2 = [];

    public string Mode = string.Empty;
    public bool adaRekod = false;

    public int SerembanJumlah = 0; public int RembauJumlah = 0; public int JelebuJumlah = 0;
    public int KualaPilahJumlah = 0; public int PortDicksonJumlah = 0; public int TampinJumlah = 0;
    public int JempolJumlah = 0;
    public int TotalJumlahTW = 0;
    public int TanahKosongTWA = 0; public int TanahKosongTWK = 0;

    public decimal SerembanPercent; public decimal JempolPercent; public decimal RembauPercent; public decimal JelebuPercent;
    public decimal KualaPilahPercent; public decimal TampinPercent; public decimal PortDicksonPercent;

    private async Task LoadFile()
    {
        await JSRuntime.InvokeVoidAsync("loadSweetAlert");
    }

    private void ShowTWAKosong()
    {
        string baseUrl = (Mode == "Dev")
        ? $"/MaklumatRekodWakaf/{"TWA"}"
        : $"/e-Takaf/MaklumatRekodWakaf/{"TWA"}";
        NavMan.NavigateTo(NavMan.ToAbsoluteUri(baseUrl).ToString(), true);
    }

    private void ShowTWKKosong()
    {
        string baseUrl = (Mode == "Dev")
        ? $"/MaklumatRekodWakaf/{"TWK"}"
        : $"/e-Takaf/MaklumatRekodWakaf/{"TWK"}";
        NavMan.NavigateTo(NavMan.ToAbsoluteUri(baseUrl).ToString(), true);
    }



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFile();
            adaRekod = (_data = await _service.GetDashboardInfo()).Any();
            _data2 = await _service.GetKegunaanTanah();
            TotalJumlahTW = _data.Sum(x => x.JumlahTanah);
            if (adaRekod)
            {

                var daerahMap = new Dictionary<string, Action<int>>
                {
                    { "Seremban", val => SerembanJumlah = val },
                    { "Kuala Pilah", val => KualaPilahJumlah = val },
                    { "Port Dickson", val => PortDicksonJumlah = val },
                    { "Tampin", val => TampinJumlah = val },
                    { "Jelebu", val => JelebuJumlah = val },
                    { "Rembau", val => RembauJumlah = val },
                    { "Jempol", val => JempolJumlah = val }
                };

                foreach (var xx in _data)
                {
                    if (daerahMap.TryGetValue(xx.Daerah, out var assignValue))
                    {
                        assignValue(xx.JumlahTanah);
                    }
                }

                if (!string.IsNullOrEmpty(TotalJumlahTW.ToString()))
                {
                    CalculatePercentage(TotalJumlahTW);
                }

                await JSRuntime.InvokeVoidAsync("updateChart", 
                    _data.Select(d => d.Daerah).ToArray(),
                    _data.Select(d => d.JumlahTanah).ToArray());

                await JSRuntime.InvokeVoidAsync("updateChart2",
                   _data2.Select(d => d.JenisHartanah).ToArray(),
                   _data2.Select(d => d.JumlahTanah).ToArray());

                TanahKosongTWA = await _service.CountJumlahTWAKosongBothKategori();
                TanahKosongTWK = await _service.CountJumlahTWKKosongBothKategori();

                StateHasChanged();
            }

            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Mode = _conf["Mode"]?.ToString() ?? string.Empty;
        var authState = await myIden.GetUserAsync();
        var user = authState.Identity as ClaimsIdentity;

        if (user == null || !user.IsAuthenticated)
        {
            await myIden.SignOutUserAsync();
            string baseUrl = (Mode == "Dev") ? "/SessiTamat" : "/e-Takaf/SessiTamat";
            NavMan.NavigateTo(NavMan.ToAbsoluteUri(baseUrl).ToString(), true);
        }
    }

    void CalculatePercentage(int jumlah)
    {
        var daerahMap = new Dictionary<string, double>
    {
        { "Seremban", SerembanJumlah },
        { "Tampin", TampinJumlah },
        { "Jempol", JempolJumlah },
        { "Kuala Pilah", KualaPilahJumlah },
        { "Rembau", RembauJumlah },
        { "Port Dickson", PortDicksonJumlah },
        { "Jelebu", JelebuJumlah }
    };

        foreach (var key in daerahMap.Keys.ToList()) // Convert keys to a list for modification
        {
            daerahMap[key] = (daerahMap[key] / (double)jumlah) * 100; // Ensure proper division
        }

        // Assign calculated percentages back to their respective variables
        SerembanPercent = Convert.ToDecimal(daerahMap["Seremban"]);
        TampinPercent = Convert.ToDecimal(daerahMap["Tampin"]);
        JempolPercent = Convert.ToDecimal(daerahMap["Jempol"]);
        KualaPilahPercent = Convert.ToDecimal(daerahMap["Kuala Pilah"]);
        RembauPercent = Convert.ToDecimal(daerahMap["Rembau"]);
        PortDicksonPercent = Convert.ToDecimal(daerahMap["Port Dickson"]);
        JelebuPercent = Convert.ToDecimal(daerahMap["Jelebu"]);
    }



}
